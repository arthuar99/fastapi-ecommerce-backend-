{% extends "base.html" %}

{% block title %}إدارة المنتجات - متجري الإلكتروني{% endblock %}
{% block page_title %}إدارة المنتجات{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
    <div>
        <h1 class="text-3xl font-bold text-gray-900 mb-2">إدارة المنتجات</h1>
        <p class="text-gray-600">أضف وحرر وأدر منتجات متجرك</p>
    </div>
    <div class="mt-4 sm:mt-0">
        <button onclick="openAddProductModal()" class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700">
            <i class="fas fa-plus ml-2"></i>
            إضافة منتج جديد
        </button>
    </div>
</div>

<!-- Filters and Search -->
<div class="bg-white rounded-lg shadow mb-6 p-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">البحث</label>
            <div class="relative">
                <input type="text" id="searchInput" placeholder="ابحث عن منتج..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">الفئة</label>
            <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <option value="">جميع الفئات</option>
                <option value="electronics">إلكترونيات</option>
                <option value="clothing">ملابس</option>
                <option value="books">كتب</option>
                <option value="home">منزل ومطبخ</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">الحالة</label>
            <select id="statusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <option value="">جميع الحالات</option>
                <option value="active">نشط</option>
                <option value="inactive">غير نشط</option>
                <option value="out-of-stock">نفد من المخزون</option>
            </select>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">الترتيب</label>
            <select id="sortFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                <option value="name">الاسم</option>
                <option value="price">السعر</option>
                <option value="stock">المخزون</option>
                <option value="created_at">تاريخ الإضافة</option>
            </select>
        </div>
    </div>
</div>

<!-- Products Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-medium text-gray-900">قائمة المنتجات</h3>
            <span class="text-sm text-gray-500" id="productsCount">{{ products|length if products else 0 }} منتج</span>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                        <input type="checkbox" id="selectAll" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                    </th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الفئة</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">السعر</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزون</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الحالة</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="productsTableBody">
                {% if products %}
                    {% for product in products %}
                    <tr class="hover:bg-gray-50" data-product-id="{{ product.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <input type="checkbox" class="product-checkbox rounded border-gray-300 text-primary-600 focus:ring-primary-500" value="{{ product.id }}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-lg object-cover" src="{{ product.image_url or '/static/images/placeholder.jpg' }}" alt="{{ product.name }}">
                                </div>
                                <div class="mr-4">
                                    <div class="text-sm font-medium text-gray-900">{{ product.name }}</div>
                                    <div class="text-sm text-gray-500">{{ product.description[:50] }}{% if product.description|length > 50 %}...{% endif %}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                {{ product.category or 'عام' }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {{ product.price }} ج.م
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if product.stock > 20 %}bg-green-100 text-green-800
                                {% elif product.stock > 5 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ product.stock }} قطعة
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if product.stock > 0 %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {% if product.stock > 0 %}نشط{% else %}نفد من المخزون{% endif %}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex items-center space-x-2 space-x-reverse">
                                <button onclick="viewProduct({{ product.id }})" class="text-blue-600 hover:text-blue-900">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="editProduct({{ product.id }})" class="text-green-600 hover:text-green-900">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct({{ product.id }})" class="text-red-600 hover:text-red-900">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="text-gray-400">
                                <i class="fas fa-box-open text-4xl mb-4"></i>
                                <p class="text-lg font-medium">لا توجد منتجات</p>
                                <p class="text-sm">ابدأ بإضافة منتج جديد</p>
                            </div>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination -->
    <div class="bg-white px-4 py-3 border-t border-gray-200 sm:px-6">
        <div class="flex items-center justify-between">
            <div class="flex-1 flex justify-between sm:hidden">
                <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">السابق</button>
                <button class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">التالي</button>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        عرض <span class="font-medium">1</span> إلى <span class="font-medium">10</span> من <span class="font-medium">{{ products|length if products else 0 }}</span> نتيجة
                    </p>
                </div>
                <div>
                    <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                        <button class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                        <button class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">1</button>
                        <button class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Actions -->
<div id="bulkActions" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-white rounded-lg shadow-lg border p-4 hidden">
    <div class="flex items-center space-x-4 space-x-reverse">
        <span class="text-sm text-gray-600" id="selectedCount">0 منتج محدد</span>
        <button onclick="bulkDelete()" class="px-3 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
            <i class="fas fa-trash ml-1"></i>حذف
        </button>
        <button onclick="bulkExport()" class="px-3 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-sm">
            <i class="fas fa-download ml-1"></i>تصدير
        </button>
        <button onclick="clearSelection()" class="px-3 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 text-sm">
            إلغاء التحديد
        </button>
    </div>
</div>

{% include 'modals/product_modal.html' %}

{% endblock %}

{% block extra_js %}
<script>
// Products page JavaScript
let selectedProducts = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupProductFilters();
    setupBulkSelection();
});

// Filter functionality
function setupProductFilters() {
    const searchInput = document.getElementById('searchInput');
    const categoryFilter = document.getElementById('categoryFilter');
    const statusFilter = document.getElementById('statusFilter');
    const sortFilter = document.getElementById('sortFilter');
    
    [searchInput, categoryFilter, statusFilter, sortFilter].forEach(element => {
        if (element) {
            element.addEventListener('change', filterProducts);
            element.addEventListener('input', filterProducts);
        }
    });
}

function filterProducts() {
    // This would typically make an API call to filter products
    // For now, we'll just show a loading state
    showToast('جارٍ تحديث النتائج...', 'info', 1000);
}

// Bulk selection
function setupBulkSelection() {
    const selectAll = document.getElementById('selectAll');
    const productCheckboxes = document.querySelectorAll('.product-checkbox');
    const bulkActions = document.getElementById('bulkActions');
    
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            productCheckboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateSelectedProducts();
        });
    }
    
    productCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedProducts);
    });
}

function updateSelectedProducts() {
    const selectedCheckboxes = document.querySelectorAll('.product-checkbox:checked');
    selectedProducts = Array.from(selectedCheckboxes).map(cb => cb.value);
    
    const bulkActions = document.getElementById('bulkActions');
    const selectedCount = document.getElementById('selectedCount');
    
    if (selectedProducts.length > 0) {
        bulkActions.classList.remove('hidden');
        selectedCount.textContent = `${selectedProducts.length} منتج محدد`;
    } else {
        bulkActions.classList.add('hidden');
    }
}

function clearSelection() {
    document.querySelectorAll('.product-checkbox').forEach(cb => cb.checked = false);
    document.getElementById('selectAll').checked = false;
    updateSelectedProducts();
}

// Product actions
function viewProduct(productId) {
    window.location.href = `/admin/products/${productId}`;
}

function editProduct(productId) {
    // Open edit modal with product data
    showToast('جارٍ تحميل بيانات المنتج...', 'info');
    // This would fetch product data and open edit modal
}

function deleteProduct(productId) {
    if (confirm('هل أنت متأكد من حذف هذا المنتج؟')) {
        showToast('جارٍ حذف المنتج...', 'info');
        // This would make API call to delete product
        setTimeout(() => {
            showToast('تم حذف المنتج بنجاح!', 'success');
        }, 1500);
    }
}

function bulkDelete() {
    if (selectedProducts.length === 0) return;
    
    if (confirm(`هل أنت متأكد من حذف ${selectedProducts.length} منتج؟`)) {
        showToast('جارٍ حذف المنتجات...', 'info');
        setTimeout(() => {
            showToast(`تم حذف ${selectedProducts.length} منتج بنجاح!`, 'success');
            clearSelection();
        }, 2000);
    }
}

function bulkExport() {
    if (selectedProducts.length === 0) return;
    
    showToast('جارٍ تصدير البيانات...', 'info');
    setTimeout(() => {
        showToast('تم تصدير البيانات بنجاح!', 'success');
    }, 1500);
}

function openAddProductModal() {
    document.getElementById('productModal').classList.remove('hidden');
}
</script>
{% endblock %}
